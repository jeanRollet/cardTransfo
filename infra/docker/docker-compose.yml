  version: '3.8'

  networks:
    carddemo-net:
      driver: bridge

  volumes:
    postgres-data:
    redis-data:
    kafka-data:
    zookeeper-data:
    zookeeper-log:

  services:
    postgresql:
      image: postgres:16-alpine
      container_name: carddemo-postgres
      environment:
        POSTGRES_DB: carddemo
        POSTGRES_USER: carddemo
        POSTGRES_PASSWORD: carddemo123
      volumes:
        - postgres-data:/var/lib/postgresql/data
        - ../config/postgresql/init-db.sql:/docker-entrypoint-initdb.d/01-init-db.sql:ro
        - ../config/postgresql/seed-data.sql:/docker-entrypoint-initdb.d/02-seed-data.sql:ro
      ports:
        - "5432:5432"
      networks:
        - carddemo-net
      healthcheck:
        test: ["CMD-SHELL", "pg_isready -U carddemo -d carddemo"]
        interval: 10s
        timeout: 5s
        retries: 5
      restart: unless-stopped

    redis:
      image: redis:7-alpine
      container_name: carddemo-redis
      command: redis-server --requirepass carddemo123
      volumes:
        - redis-data:/data
      ports:
        - "6379:6379"
      networks:
        - carddemo-net
      restart: unless-stopped

    frontend:
      build:
        context: ../../frontend
        dockerfile: Dockerfile
      container_name: carddemo-frontend
      ports:
        - "3000:80"
      networks:
        - carddemo-net
      depends_on:
        - auth-service
        - card-service
        - account-service
        - transaction-service
      restart: unless-stopped

    auth-service:
      build:
        context: ../../appli
        dockerfile: auth-service/Dockerfile
      container_name: carddemo-auth
      environment:
        SPRING_PROFILES_ACTIVE: docker
        JWT_SECRET: carddemo-secret-key-change-in-production-minimum-256-bits
      ports:
        - "8081:8081"
      networks:
        - carddemo-net
      depends_on:
        postgresql:
          condition: service_healthy
        redis:
          condition: service_started
      healthcheck:
        test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/actuator/health"]
        interval: 30s
        timeout: 10s
        start_period: 60s
        retries: 3
      restart: unless-stopped

    card-service:
      build:
        context: ../../appli
        dockerfile: card-service/Dockerfile
      container_name: carddemo-card
      environment:
        SPRING_PROFILES_ACTIVE: docker
        JWT_SECRET: carddemo-secret-key-change-in-production-minimum-256-bits
      ports:
        - "8082:8082"
      networks:
        - carddemo-net
      depends_on:
        postgresql:
          condition: service_healthy
        kafka:
          condition: service_healthy
      healthcheck:
        test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/actuator/health"]
        interval: 30s
        timeout: 10s
        start_period: 60s
        retries: 3
      restart: unless-stopped

    account-service:
      build:
        context: ../../appli
        dockerfile: account-service/Dockerfile
      container_name: carddemo-account
      environment:
        SPRING_PROFILES_ACTIVE: docker
        JWT_SECRET: carddemo-secret-key-change-in-production-minimum-256-bits
      ports:
        - "8083:8083"
      networks:
        - carddemo-net
      depends_on:
        postgresql:
          condition: service_healthy
        kafka:
          condition: service_healthy
      healthcheck:
        test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083/actuator/health"]
        interval: 30s
        timeout: 10s
        start_period: 60s
        retries: 3
      restart: unless-stopped

    transaction-service:
      build:
        context: ../../appli
        dockerfile: transaction-service/Dockerfile
      container_name: carddemo-transaction
      environment:
        SPRING_PROFILES_ACTIVE: docker
        JWT_SECRET: carddemo-secret-key-change-in-production-minimum-256-bits
      ports:
        - "8084:8084"
      networks:
        - carddemo-net
      depends_on:
        postgresql:
          condition: service_healthy
        kafka:
          condition: service_healthy
      healthcheck:
        test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8084/actuator/health"]
        interval: 30s
        timeout: 10s
        start_period: 60s
        retries: 3
      restart: unless-stopped

    partner-service:
      build:
        context: ../../appli
        dockerfile: partner-service/Dockerfile
      container_name: carddemo-partner
      environment:
        SPRING_PROFILES_ACTIVE: docker
        SPRING_DATA_REDIS_PASSWORD: carddemo123
      ports:
        - "8085:8085"
      networks:
        - carddemo-net
      depends_on:
        postgresql:
          condition: service_healthy
        redis:
          condition: service_started
        account-service:
          condition: service_healthy
        card-service:
          condition: service_healthy
        transaction-service:
          condition: service_healthy
      healthcheck:
        test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8085/actuator/health"]
        interval: 30s
        timeout: 10s
        start_period: 60s
        retries: 3
      restart: unless-stopped

    # ============================================================================
    # Kafka Infrastructure (replaces MQ Series from mainframe)
    # ============================================================================

    zookeeper:
      image: confluentinc/cp-zookeeper:7.5.0
      container_name: carddemo-zookeeper
      environment:
        ZOOKEEPER_CLIENT_PORT: 2181
        ZOOKEEPER_TICK_TIME: 2000
      volumes:
        - zookeeper-data:/var/lib/zookeeper/data
        - zookeeper-log:/var/lib/zookeeper/log
      networks:
        - carddemo-net
      healthcheck:
        test: ["CMD", "nc", "-z", "localhost", "2181"]
        interval: 10s
        timeout: 5s
        retries: 5
      restart: unless-stopped

    kafka:
      image: confluentinc/cp-kafka:7.5.0
      container_name: carddemo-kafka
      depends_on:
        zookeeper:
          condition: service_healthy
      environment:
        KAFKA_BROKER_ID: 1
        KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
        KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
        KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
        KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
        KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
        KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
        KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
        KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
      volumes:
        - kafka-data:/var/lib/kafka/data
      ports:
        - "29092:29092"
      networks:
        - carddemo-net
      healthcheck:
        test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
        interval: 10s
        timeout: 10s
        retries: 10
        start_period: 30s
      restart: unless-stopped

    kafka-init:
      image: confluentinc/cp-kafka:7.5.0
      container_name: carddemo-kafka-init
      depends_on:
        kafka:
          condition: service_healthy
      networks:
        - carddemo-net
      command: >
        bash -c "
          echo 'Creating Kafka topics...'
          kafka-topics --create --if-not-exists --topic carddemo.transactions --bootstrap-server kafka:9092 --partitions 8 --replication-factor 1 --config retention.ms=604800000
          kafka-topics --create --if-not-exists --topic carddemo.cards --bootstrap-server kafka:9092 --partitions 4 --replication-factor 1 --config retention.ms=604800000
          kafka-topics --create --if-not-exists --topic carddemo.accounts --bootstrap-server kafka:9092 --partitions 4 --replication-factor 1 --config retention.ms=604800000
          kafka-topics --create --if-not-exists --topic carddemo.dlq --bootstrap-server kafka:9092 --partitions 4 --replication-factor 1 --config retention.ms=2592000000
          echo 'Topics created successfully:'
          kafka-topics --list --bootstrap-server kafka:9092
        "
      restart: "no"

    notification-service:
      build:
        context: ../../appli
        dockerfile: notification-service/Dockerfile
      container_name: carddemo-notification
      environment:
        SPRING_PROFILES_ACTIVE: docker
      ports:
        - "8086:8086"
      networks:
        - carddemo-net
      depends_on:
        postgresql:
          condition: service_healthy
        kafka:
          condition: service_healthy
      healthcheck:
        test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8086/actuator/health"]
        interval: 30s
        timeout: 10s
        start_period: 60s
        retries: 3
      restart: unless-stopped
